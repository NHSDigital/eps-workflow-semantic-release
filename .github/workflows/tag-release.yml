name: Tag Release

on:
  workflow_call:
    inputs:
      tagFormat:
        type: string
        required: false
        default: "v${version}"
      semRelArgs:
        type: string
        required: false
        default: ""

jobs:
  tag_release:
    runs-on: ubuntu-22.04
    outputs:
      version_tag: ${{steps.output_version_tag.outputs.VERSION_TAG}}
    steps:
      - name: Find calling tag
        id: find_calling_tag
        run: |
          # pull tag from github.workflow_ref to know which tag to checkout in next step
          echo "Workflow called from ${{ github.workflow_ref }}"

          CALLING_REF="${{ github.workflow_ref }}"
          CALLING_TAG="${CALLING_REF#*@}"

          echo "Calling tag: ${CALLING_TAG}"

          echo "CALLING_TAG=${CALLING_TAG}" >> "$GITHUB_ENV"

      - name: Checkout semantic-release workflow
        uses: actions/checkout@v5
        with:
          repository: NHSDigital/eps-workflow-semantic-release
          ref: ${{ env.CALLING_TAG }}

      # using git commit sha for version of action to ensure we have stable version
      - name: Install asdf
        uses: asdf-vm/actions/setup@1902764435ca0dd2f3388eea723a4f92a4eb8302
        with:
          asdf_branch: v0.11.3

      - name: Cache asdf
        uses: actions/cache@v4
        with:
          path: |
            ~/.asdf
          key: ${{ runner.os }}-asdf-${{ hashFiles('**/.tool-versions') }}
          restore-keys: |
            ${{ runner.os }}-asdf-

      - name: Install asdf dependencies in .tool-versions
        uses: asdf-vm/actions/install@1902764435ca0dd2f3388eea723a4f92a4eb8302
        with:
          asdf_branch: v0.11.3

      - name: Install node packages
        run: |
          npm ci

      - name: Partial-clone calling repo
        uses: actions/checkout@v5
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.sha }}
          path: calling-repo

      - name: Set VERSION_TAG env var to be short git SHA and get next tag version
        id: output_version_tag
        working-directory: calling-repo
        run: |
          VERSION_TAG=$(git rev-parse --short HEAD)
          NEXT_VERSION=$(npx semantic-release --dry-run ${{ inputs.semRelArgs }} | grep -i 'The next release version is' | sed -E 's/.* ([[:digit:].]+)$/\1/')

          # disabling shellcheck as replace does not work
          # shellcheck disable=SC2001
          VERSION_TAG=$(echo "${{ inputs.tagFormat }}" | sed "s/\${version}/$NEXT_VERSION/")

          echo "## VERSION TAG : ${VERSION_TAG}" >> "$GITHUB_STEP_SUMMARY"
          echo "VERSION_TAG=${VERSION_TAG}" >> "$GITHUB_OUTPUT"
          echo "VERSION_TAG=${VERSION_TAG}" >> "$GITHUB_ENV"
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: tag release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        working-directory: calling-repo
        run: |
          npx semantic-release ${{ inputs.semRelArgs }}

      - name: Get release for editing
        id: get_release
        # version 1.2.4
        uses: cardinalby/git-get-release-action@5172c3a026600b1d459b117738c605fabc9e4e44
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          repo: ${{ github.repository }}
          tag: ${{ env.VERSION_TAG }}

      - name: Edit Release
        # version 1.2.0
        uses: irongut/EditRelease@ccf529ad26dddf9996e7dd0f24ca5da4ea507cc2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          id: ${{ steps.get_release.outputs.id }}
          body: |
            ## Info
            [See code diff](${{ github.event.compare }})
            [Release workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            It was initialized by [${{ github.event.sender.login }}](${{ github.event.sender.html_url }})
